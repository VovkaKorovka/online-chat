<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>Онлайн чат</title>
<style>
body { font-family: Arial; margin: 0; display: flex; flex-direction: column; height: 100vh; }
#chat { flex: 1; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; }
.message { max-width: 60%; padding: 8px 12px; margin-bottom: 5px; border-radius: 10px; }
.message.self { align-self: flex-end; background: #4a90e2; color: white; }
.message.other { align-self: flex-start; background: #e5e5ea; color: black; }
.message.system { align-self: center; background: #f0f0f0; color: gray; font-style: italic; }
#status { padding: 5px 10px; border-top: 1px solid #ccc; background: #fafafa; }
#input { display: flex; border-top: 1px solid #ccc; }
#input input { flex: 1; padding: 10px; border: none; outline: none; }
#input button { padding: 10px 15px; border: none; background: #4a90e2; color: white; cursor: pointer; }
#input button:hover { background: #357ab8; }
</style>
</head>
<body>

<div id="chat"></div>
<div id="status">Онлайн: 0</div>
<div id="input">
    <input type="text" id="msg" placeholder="Напиши повідомлення...">
    <button id="send">Відправити</button>
</div>

<script>
const chat = document.getElementById("chat");
const status = document.getElementById("status");
const msgInput = document.getElementById("msg");
const sendBtn = document.getElementById("send");

const ws = new WebSocket(`ws://${window.location.host}`);
let userName = "";
let typingUsers = new Set();

ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);

    if(msg.type === "init") {
        userName = msg.user;
        status.textContent = `Онлайн: ${msg.online}`;
    }

    if(msg.type === "system") {
        addMessage(msg.text, "system");
        status.textContent = `Онлайн: ${msg.online}`;
    }

    if(msg.type === "chat") {
        const cls = msg.user === userName ? "self" : "other";
        addMessage(`${msg.user}: ${msg.text}`, cls);
    }

    if(msg.type === "typing") {
        if(msg.user !== userName) {
            typingUsers.add(msg.user);
            updateTyping();
        }
    }
};

function addMessage(text, cls) {
    const div = document.createElement("div");
    div.className = `message ${cls}`;
    div.textContent = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

function updateTyping() {
    if(typingUsers.size === 0) {
        status.textContent = `Онлайн: ${ws ? "?" : 0}`;
    } else {
        const names = Array.from(typingUsers).join(", ");
        status.textContent = `${names} пише…`;
    }
}

function sendMessage() {
    const text = msgInput.value.trim();
    if(text === "") return;
    ws.send(JSON.stringify({ type: "chat", text }));
    msgInput.value = "";
}

sendBtn.onclick = sendMessage;
msgInput.addEventListener("keydown", (e) => {
    if(e.key === "Enter") sendMessage();
    else ws.send(JSON.stringify({ type:"typing" }));
});
</script>

</body>
</html>
