<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<title>Онлайн чат</title>
<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    height: 100vh;
    background: #f5f5f5;
}

#chat {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    display: flex;
    flex-direction: column;
}

.message {
    max-width: 60%;
    padding: 10px 15px;
    margin-bottom: 10px;
    border-radius: 20px;
    word-wrap: break-word;
}

.message.self {
    align-self: flex-end;
    background: #4a90e2;
    color: white;
    border-bottom-right-radius: 0;
}

.message.other {
    align-self: flex-start;
    background: #e5e5ea;
    color: black;
    border-bottom-left-radius: 0;
}

.message.system {
    align-self: center;
    background: #f0f0f0;
    color: gray;
    font-style: italic;
    border-radius: 10px;
    max-width: 80%;
}

#status {
    font-size: 0.9em;
    color: #555;
    padding: 5px 15px;
    background: #fafafa;
    border-top: 1px solid #ddd;
}

#input {
    display: flex;
    border-top: 1px solid #ddd;
    background: #fff;
}

#input input {
    flex: 1;
    padding: 12px 15px;
    border: none;
    font-size: 1em;
    outline: none;
}

#input button {
    padding: 12px 20px;
    border: none;
    background: #4a90e2;
    color: white;
    cursor: pointer;
    font-weight: bold;
}

#input button:hover {
    background: #357ab8;
}

::-webkit-scrollbar {
    width: 8px;
}

::-webkit-scrollbar-thumb {
    background: rgba(0,0,0,0.2);
    border-radius: 4px;
}
</style>
</head>
<body>

<div id="chat"></div>
<div id="status">Онлайн: 0</div>

<div id="input">
    <input type="text" id="msg" placeholder="Напиши повідомлення...">
    <button id="send">Відправити</button>
</div>

<script>
// Ім'я користувача з localStorage або prompt
let userName = localStorage.getItem("chatName") || prompt("Введіть ваше ім'я або назву ПК:", "Мій ПК");
localStorage.setItem("chatName", userName);

const chat = document.getElementById("chat");
const status = document.getElementById("status");
const msgInput = document.getElementById("msg");
const sendBtn = document.getElementById("send");

const ws = new WebSocket(`wss://${window.location.host}`);
ws.initialName = userName;

let typingUsers = new Set();

ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);

    if(msg.type === "init") {
        status.textContent = `Онлайн: ${msg.online}`;
    }

    if(msg.type === "system") {
        addMessage(msg.text, "system");
        status.textContent = `Онлайн: ${msg.online}`;
    }

    if(msg.type === "chat") {
        const cls = msg.user === userName ? "self" : "other";
        addMessage(`${msg.user}: ${msg.text}`, cls);
        typingUsers.delete(msg.user);
        updateTyping();
    }

    if(msg.type === "typing") {
        if(msg.user !== userName) {
            typingUsers.add(msg.user);
            updateTyping();
        }
    }

    if(msg.type === "removeTyping") {
        typingUsers.delete(msg.user);
        updateTyping();
    }
};

function addMessage(text, cls) {
    const div = document.createElement("div");
    div.className = `message ${cls}`;
    div.textContent = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

function updateTyping() {
    if(typingUsers.size === 0) {
        status.textContent = `Онлайн: ${ws ? "?" : 0}`;
    } else {
        const names = Array.from(typingUsers).join(", ");
        status.textContent = `${names} пише…`;
    }
}

function sendMessage() {
    const text = msgInput.value.trim();
    if(text === "") return;
    ws.send(JSON.stringify({ type: "chat", text }));
    msgInput.value = "";
}

sendBtn.onclick = sendMessage;
msgInput.addEventListener("keydown", (e) => {
    if(e.key === "Enter") sendMessage();
    else ws.send(JSON.stringify({ type:"typing" }));
});
</script>

</body>
</html>

