<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <title>Онлайн чат</title>
    <style>
        body {
            font-family: sans-serif;
            margin:0;
            padding:0;
            display:flex;
            flex-direction:column;
            height:100vh;
            background-color:#121212;
            color:#e0e0e0;
        }
        #online-list {
            padding:10px;
            border-bottom:1px solid #333;
            background-color:#1e1e1e;
        }
        #chat {
            flex:1;
            overflow-y:auto;
            padding:10px;
            display:flex;
            flex-direction:column;
        }
        #typing-status {
            font-size:0.9em;
            color:#888;
            padding:5px 10px;
            height:18px;
        }
        #input {
            display:flex;
            border-top:1px solid #333;
        }
        #input input {
            flex:1;
            padding:10px;
            font-size:1em;
            background-color:#1e1e1e;
            color:#e0e0e0;
            border:none;
        }
        #input input:focus {
            outline:none;
        }
        #input button {
            padding:10px;
            background-color:#6200ee;
            color:white;
            border:none;
            cursor:pointer;
        }
        #input button:hover {
            background-color:#3700b3;
        }
        .message {
            margin-bottom:5px;
            padding:8px 12px;
            border-radius:12px;
            max-width:70%;
            word-wrap: break-word;
        }
        .mine {
            background-color:#6200ee;
            color:white;
            align-self:flex-end;
        }
        .other {
            background-color:#333;
            color:#e0e0e0;
            align-self:flex-start;
        }
        .system {
            color: #ff9800;
            font-style: italic;
            text-align:center;
            align-self:center;
        }
    </style>
</head>
<body>
    <div id="online-list">Онлайн: ...</div>
    <div id="chat"></div>
    <div id="typing-status"></div>
    <div id="input">
        <input type="text" id="msg" placeholder="Напиши повідомлення...">
        <button id="send">Відправити</button>
    </div>

    <script>
        const chat = document.getElementById("chat");
        const onlineList = document.getElementById("online-list");
        const typingStatus = document.getElementById("typing-status");
        const msgInput = document.getElementById("msg");
        const sendBtn = document.getElementById("send");

        const ws = new WebSocket(`wss://${window.location.host}`);
        let userName = "";
        let onlineUsers = [];

        ws.onopen = () => console.log("Підключено до сервера");

        ws.onmessage = (event) => {
            const msg = JSON.parse(event.data);

            // Ініціалізація
            if(msg.type === "init") {
                userName = msg.user;
                onlineUsers = msg.onlineUsers || [];
                updateOnlineList();
            }

            // Системні повідомлення (підключення / вихід)
            if(msg.type === "system") {
                const div = document.createElement("div");
                div.className = "message system";
                div.textContent = msg.text;
                chat.appendChild(div);

                onlineUsers = msg.onlineUsers || onlineUsers;
                updateOnlineList();
                chat.scrollTop = chat.scrollHeight;
            }

            // Повідомлення від користувачів
            if(msg.type === "chat") {
                const div = document.createElement("div");
                div.className = "message";
                div.textContent = `${msg.user}: ${msg.text}`;
                div.classList.add(msg.user === userName ? "mine" : "other");
                chat.appendChild(div);
                chat.scrollTop = chat.scrollHeight;
            }

            // Пише...
            if(msg.type === "typing") {
                typingStatus.textContent = `${msg.user} пише...`;
                setTimeout(() => {
                    typingStatus.textContent = "";
                }, 1000);
            }
        };

        function updateOnlineList() {
            const names = onlineUsers.includes(userName) 
                ? onlineUsers.map(n => n === userName ? "Ви" : n)
                : ["Ви", ...onlineUsers];
            onlineList.textContent = `Чат із: ${names.join(", ")}`;
        }

        function sendMessage() {
            const text = msgInput.value.trim();
            if(text === "") return;
            ws.send(JSON.stringify({ type: "chat", text }));
            msgInput.value = "";
        }

        sendBtn.onclick = sendMessage;
        msgInput.addEventListener("keydown", (e) => {
            if(e.key === "Enter") sendMessage();
            else ws.send(JSON.stringify({ type:"typing" }));
        });
    </script>
</body>
</html>
